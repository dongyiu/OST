%%{init: {'theme': 'neutral', 'themeVariables': { 'fontSize': '12px'}}}%%
flowchart TD
    %% Main System Flow
    Resume[["Resume PDF"]] --> Parser[[PDF Parser]]
    Parser -->|Extracted Text| Extractor[[Job Field Extractor]]
    Extractor -->|Job Field| Generator[[Question Generator]]
    Generator -->|Personalized Questions| Manager[[Dynamic Question Manager]]
    Manager -->|Structured Data| Storage[[Data Storage]]
    Storage --> MongoDB[("MongoDB<br>---<br>• Session ID<br>• Job Field<br>• Standard Variables<br>• Custom Variables<br>• API Stats")]

    %% API Subsystem
    subgraph Rate_Limited["Rate-Optimized API Gateway"]
        direction TB
        API[[Rate-Limited API]] -->|Exponential<br>Backoff| Retry
        API -->|Cache<br>Management| Cache[SimpleCache]
        API --> Gemini[[Gemini API]]
    end

    %% Meta-Reasoning
    subgraph Meta_System["Meta-Reasoning Controller"]
        direction TB
        MA1[["API Call Tracking<br>Consecutive Calls<br>Error Counters"]]
        MA2[["Confidence Analysis<br>Progress Monitoring<br>Similarity Checks"]]
        MA3[["Circular Reasoning<br>Detection<br>History Tracking"]]
        MA4[["Efficiency Analysis<br>Cost-Benefit Decisions<br>User Intervention"]]
    end

    %% User Interaction
    User[["Job Seeker"]] -->|Upload| Resume
    User <-->|Q&A Session| Manager

    %% Connections
    Extractor -->|Uses| Rate_Limited
    Generator -->|Uses| Rate_Limited
    Manager -->|Uses| Rate_Limited
    Manager -->|Consults| Meta_System
    Meta_System -->|Monitors| Rate_Limited

    %% Styling
    classDef box fill:#e0f2fe,stroke:#0369a1;
    classDef process fill:#f0fdf4,stroke:#15803d;
    classDef data fill:#fff1f2,stroke:#be123c;
    
    class Rate_Limited,Meta_System box
    class Parser,Extractor,Generator,Manager,Storage,API,Retry,Cache,Gemini process
    class Resume,User,MongoDB data